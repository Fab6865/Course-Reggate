<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sailing Race Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            overflow-x: hidden;
        }

        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .nav-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(145deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(145deg, #27ae60, #229954);
        }

        .btn.warning {
            background: linear-gradient(145deg, #f39c12, #e67e22);
        }

        .btn.danger {
            background: linear-gradient(145deg, #e74c3c, #c0392b);
        }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .form-group select, .form-group input {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
        }

        .slider-container {
            margin: 20px 0;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .optimization-indicator {
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .optimization-indicator.optimal {
            background: #27ae60;
            color: white;
        }

        .optimization-indicator.good {
            background: #f39c12;
            color: white;
        }

        .optimization-indicator.poor {
            background: #e74c3c;
            color: white;
        }

        .race-map {
            width: 100%;
            height: 300px;
            background: linear-gradient(180deg, #87CEEB 0%, #4682B4 100%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            border: 3px solid rgba(255,255,255,0.3);
        }

        .race-track {
            position: absolute;
            top: 50%;
            left: 10%;
            right: 10%;
            height: 4px;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FF6347, #32CD32);
            border-radius: 2px;
            transform: translateY(-50%);
        }

        .checkpoint {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #FFD700;
            border: 3px solid white;
            border-radius: 50%;
            top: 50%;
            transform: translateY(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .checkpoint.start {
            left: 8%;
            background: #32CD32;
        }

        .checkpoint.mid1 {
            left: 35%;
            background: #FFA500;
        }

        .checkpoint.mid2 {
            left: 65%;
            background: #FF6347;
        }

        .checkpoint.finish {
            right: 8%;
            background: #FFD700;
        }

        .player-boat {
            position: absolute;
            width: 40px;
            height: 30px;
            top: 50%;
            transform: translateY(-50%);
            transition: left 1s ease;
            z-index: 10;
        }

        .competitor-boat {
            position: absolute;
            width: 35px;
            height: 25px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.8;
            z-index: 5;
        }

        .boat-animation {
            animation: sailing 3s ease-in-out infinite;
        }

        @keyframes sailing {
            0%, 100% { transform: translateY(-50%) rotate(-2deg); }
            50% { transform: translateY(-60%) rotate(2deg); }
        }

        .wave-effect {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 1px, transparent 1px),
                radial-gradient(circle at 60% 60%, rgba(255,255,255,0.1) 1px, transparent 1px),
                radial-gradient(circle at 80% 30%, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px, 70px 70px, 90px 90px;
            animation: waveMovement 8s linear infinite;
            opacity: 0.6;
        }

        @keyframes waveMovement {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100px); }
        }

        .race-legend {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .wind-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .race-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-card {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.3s ease;
        }

        .leaderboard {
            max-height: 400px;
            overflow-y: auto;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .weather-alert {
            background: rgba(255,193,7,0.9);
            color: #333;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .save-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }
            .btn {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran principal -->
    <div id="main-screen" class="screen active">
        <div class="header">
            <h1>‚õµ Sailing Race</h1>
            <p>Naviguez vers la victoire !</p>
        </div>
        
        <div class="nav-buttons">
            <button class="btn success" onclick="showScreen('race-setup')">üèÅ Nouvelle Course</button>
            <button class="btn" onclick="showScreen('race-screen')" id="continue-race-btn" style="display: none;">üìç Continuer la Course</button>
            <button class="btn" onclick="showScreen('shop')">üõí Boutique</button>
            <button class="btn" onclick="showScreen('rankings')">üèÜ Classements</button>
            <button class="btn" onclick="showScreen('manager')">‚öôÔ∏è Manager</button>
        </div>

        <div class="save-buttons">
            <button class="btn warning" onclick="saveGame()">üíæ Sauvegarder</button>
            <button class="btn" onclick="loadGame()">üìÅ Charger</button>
            <button class="btn" onclick="exportSave()">üì§ Exporter</button>
            <input type="file" id="import-file" style="display: none;" onchange="importSave()" accept=".json">
            <button class="btn" onclick="document.getElementById('import-file').click()">üì• Importer</button>
        </div>

        <div class="card">
            <h3>Statistiques du Joueur</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Argent</h4>
                    <p id="player-money">1000 ‚Ç¨</p>
                </div>
                <div class="stat-card">
                    <h4>Courses Termin√©es</h4>
                    <p id="races-completed">0</p>
                </div>
                <div class="stat-card">
                    <h4>Victoires</h4>
                    <p id="victories">0</p>
                </div>
                <div class="stat-card">
                    <h4>Meilleur Temps</h4>
                    <p id="best-time">--:--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Configuration de course -->
    <div id="race-setup" class="screen">
        <div class="header">
            <h1>üèÅ Configuration de Course</h1>
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="showScreen('main-screen')">üè† Accueil</button>
        </div>

        <div class="card">
            <div class="form-group">
                <label>Niveau de Difficult√©</label>
                <select id="difficulty-select">
                    <option value="debutant">D√©butant (Bonus vitesse +20%)</option>
                    <option value="intermediaire">Interm√©diaire (Normal)</option>
                    <option value="expert">Expert (Bonus r√©compenses +50%)</option>
                </select>
            </div>

            <div class="form-group">
                <label>Dur√©e de la Course</label>
                <select id="duration-select">
                    <option value="5">5 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 heure</option>
                    <option value="180">3 heures</option>
                    <option value="720">12 heures</option>
                    <option value="1440">24 heures</option>
                    <option value="4320">3 jours</option>
                </select>
            </div>

            <button class="btn success" onclick="startRace()">üöÄ Lancer la Course</button>
        </div>
    </div>

    <!-- √âcran de course -->
    <div id="race-screen" class="screen">
        <div class="header">
            <h1>üèÅ Course en Cours</h1>
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="showScreen('main-screen')">üè† Accueil</button>
            <button class="btn" onclick="showScreen('shop')">üõí Boutique</button>
            <button class="btn" onclick="showScreen('rankings')">üèÜ Classements</button>
            <button class="btn danger" onclick="abandonRace()">üö´ Abandonner</button>
        </div>

        <div class="race-info">
            <div class="info-card">
                <h4>Position</h4>
                <p id="race-position">1/10</p>
            </div>
            <div class="info-card">
                <h4>Vitesse</h4>
                <p id="race-speed">15 n≈ìuds</p>
            </div>
            <div class="info-card">
                <h4>Temps √âcoul√©</h4>
                <p id="race-time">00:00</p>
            </div>
            <div class="info-card">
                <h4>Progression</h4>
                <p id="race-progress">0%</p>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar"></div>
        </div>

        <div class="race-map">
            <div class="wave-effect"></div>
            <div class="wind-indicator" id="wind-indicator">
                üå¨Ô∏è Vent: 15 nds NE
            </div>
            
            <div class="race-track"></div>
            
            <div class="checkpoint start"></div>
            <div class="checkpoint mid1"></div>
            <div class="checkpoint mid2"></div>
            <div class="checkpoint finish"></div>
            
            <div class="player-boat boat-animation" id="player-boat">
                <svg viewBox="0 0 40 30" style="width: 100%; height: 100%;">
                    <polygon points="20,5 10,25 30,25" fill="#8B4513"/>
                    <polygon points="20,5 20,22 17,22" fill="#FFF"/>
                    <circle cx="20" cy="15" r="2" fill="#FF0000"/>
                </svg>
            </div>
            
            <div class="competitor-boat" id="competitor-1" style="left: 25%; top: 45%;">
                <svg viewBox="0 0 35 25" style="width: 100%; height: 100%;">
                    <polygon points="17,3 8,22 26,22" fill="#654321"/>
                    <polygon points="17,3 17,19 15,19" fill="#E6E6FA"/>
                </svg>
            </div>
            
            <div class="competitor-boat" id="competitor-2" style="left: 20%; top: 55%;">
                <svg viewBox="0 0 35 25" style="width: 100%; height: 100%;">
                    <polygon points="17,3 8,22 26,22" fill="#2F4F4F"/>
                    <polygon points="17,3 17,19 15,19" fill="#F0F8FF"/>
                </svg>
            </div>
            
            <div class="competitor-boat" id="competitor-3" style="left: 15%; top: 60%;">
                <svg viewBox="0 0 35 25" style="width: 100%; height: 100%;">
                    <polygon points="17,3 8,22 26,22" fill="#556B2F"/>
                    <polygon points="17,3 17,19 15,19" fill="#FFFACD"/>
                </svg>
            </div>
        </div>

        <div class="race-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #32CD32;"></div>
                <span>D√©part</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFA500;"></div>
                <span>Checkpoint 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FF6347;"></div>
                <span>Checkpoint 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD700;"></div>
                <span>Arriv√©e</span>
            </div>
        </div>

        <div id="weather-alert" class="weather-alert" style="display: none;">
            ‚õàÔ∏è Alerte M√©t√©o : Temp√™te approchant ! Ajustez vos voiles !
        </div>

        <div class="card">
            <h3>Contr√¥les du Voilier</h3>
            
            <div class="form-group">
                <label>Type de Voiles</label>
                <select id="sail-type-select" onchange="changeSailType()">
                    <option value="storm">‚õàÔ∏è Voiles de Temp√™te (Stable)</option>
                    <option value="reduced">üå¨Ô∏è Voiles R√©duites (√âquilibr√©)</option>
                    <option value="full" selected>‚õµ Voiles Compl√®tes (Standard)</option>
                    <option value="light">üçÉ Voiles L√©g√®res (Vent faible)</option>
                    <option value="spinnaker">üöÄ Spinnaker (Vent arri√®re)</option>
                </select>
            </div>
            
            <div class="slider-container">
                <label>Orientation des Voiles (0-100%)</label>
                <input type="range" class="slider" id="sail-slider" min="0" max="100" value="50" oninput="updateSailOptimization()">
                <p>Valeur: <span id="sail-value">50</span>%</p>
            </div>

            <div class="slider-container">
                <label>Cap (0-360¬∞)</label>
                <input type="range" class="slider" id="heading-slider" min="0" max="360" value="180" oninput="updateHeadingOptimization()">
                <p>Valeur: <span id="heading-value">180</span>¬∞</p>
            </div>

            <div class="optimization-indicator" id="optimization-status">
                üü° Optimisation Moyenne
            </div>

            <div class="race-info">
                <div class="info-card">
                    <h4>Fatigue √âquipage</h4>
                    <p id="crew-fatigue">0%</p>
                </div>
                <div class="info-card">
                    <h4>Pilote Auto</h4>
                    <button class="btn" id="autopilot-btn" onclick="toggleAutopilot()">‚ñ∂Ô∏è Activer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Boutique -->
    <div id="shop" class="screen">
        <div class="header">
            <h1>üõí Boutique</h1>
            <p>Argent disponible: <span id="shop-money">1000 ‚Ç¨</span></p>
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="showScreen('main-screen')">üè† Accueil</button>
            <button class="btn" onclick="showScreen('race-screen')" id="shop-race-btn" style="display: none;">üìç Retour √† la Course</button>
        </div>

        <div class="card">
            <h3>Am√©liorations Disponibles</h3>
            <div id="shop-items">
                <!-- Items g√©n√©r√©s par JavaScript -->
            </div>
        </div>
    </div>

    <!-- Classements -->
    <div id="rankings" class="screen">
        <div class="header">
            <h1>üèÜ Classements</h1>
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="showScreen('main-screen')">üè† Accueil</button>
            <button class="btn" onclick="showScreen('race-screen')" id="rankings-race-btn" style="display: none;">üìç Retour √† la Course</button>
        </div>

        <div class="card">
            <h3>Historique des Courses</h3>
            <div class="leaderboard" id="race-history">
                <!-- Historique g√©n√©r√© par JavaScript -->
            </div>
        </div>

        <div class="card">
            <h3>Classement Actuel</h3>
            <div class="leaderboard" id="current-leaderboard">
                <!-- Classement g√©n√©r√© par JavaScript -->
            </div>
        </div>
    </div>

    <!-- Manager -->
    <div id="manager" class="screen">
        <div class="header">
            <h1>‚öôÔ∏è Manager</h1>
        </div>
        
        <div class="nav-buttons">
            <button class="btn" onclick="showScreen('main-screen')">üè† Accueil</button>
        </div>

        <div class="card">
            <h3>Gestion des Prix</h3>
            <div id="manager-items">
                <!-- Items de gestion g√©n√©r√©s par JavaScript -->
            </div>
            <button class="btn warning" onclick="resetPrices()">üîÑ R√©initialiser les Prix</button>
        </div>

        <div class="card">
            <h3>Statistiques du Jeu</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Argent Total Gagn√©</h4>
                    <p id="total-earned">0 ‚Ç¨</p>
                </div>
                <div class="stat-card">
                    <h4>Temps Total Jou√©</h4>
                    <p id="total-playtime">0h 0m</p>
                </div>
                <div class="stat-card">
                    <h4>Am√©liorations Achet√©es</h4>
                    <p id="upgrades-bought">0</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales du jeu
        let gameState = {
            player: {
                money: 1000,
                racesCompleted: 0,
                victories: 0,
                bestTime: null,
                totalEarned: 0,
                totalPlaytime: 0,
                upgradesBought: 0
            },
            currentRace: null,
            upgrades: {
                hull: 0,
                sail: 0,
                rudder: 0,
                engine: 0,
                autopilot: 0
            },
            raceHistory: [],
            shopPrices: {
                hull: 500,
                sail: 300,
                rudder: 200,
                engine: 800,
                autopilot: 1000
            },
            weatherIntervalMinutes: 5, // Intervalle entre intemp√©ries (en minutes, modifiable par le manager)
            startTime: Date.now()
        };

        // Donn√©es des am√©liorations
        const upgradeData = {
            hull: { name: "Coque Renforc√©e", effect: "Vitesse +5%", maxLevel: 10 },
            sail: { name: "Voiles Haute Performance", effect: "Maniabilit√© +10%", maxLevel: 10 },
            rudder: { name: "Gouvernail Optimis√©", effect: "Contr√¥le +15%", maxLevel: 10 },
            engine: { name: "Moteur Auxiliaire", effect: "Vitesse de base +20%", maxLevel: 5 },
            autopilot: { name: "Pilote Automatique", effect: "Performance hors ligne +20%", maxLevel: 10 }
        };

        // √âv√©nements m√©t√©o avec fr√©quence adaptative
        const weatherEvents = [
            { name: "Temp√™te", effect: "R√©duction vitesse 30%", duration: 120000, sailChange: "storm" },
            { name: "Vent Favorable", effect: "Bonus vitesse 20%", duration: 180000, sailChange: "spinnaker" },
            { name: "Calme Plat", effect: "Vitesse r√©duite 50%", duration: 90000, sailChange: "light" },
            { name: "Grain", effect: "Contr√¥le difficile", duration: 60000, sailChange: "reduced" },
            { name: "Vent Arri√®re", effect: "Bonus spinnaker", duration: 150000, sailChange: "spinnaker" },
            { name: "Vent de Travers", effect: "Voiles optimales", duration: 120000, sailChange: "full" }
        ];

        // Types de voiles
        const sailTypes = {
            storm: { name: "Voiles de Temp√™te", speed: 0.6, stability: 1.5 },
            reduced: { name: "Voiles R√©duites", speed: 0.8, stability: 1.2 },
            full: { name: "Voiles Compl√®tes", speed: 1.0, stability: 1.0 },
            light: { name: "Voiles L√©g√®res", speed: 0.7, stability: 0.9 },
            spinnaker: { name: "Spinnaker", speed: 1.3, stability: 0.7 }
        };

        // Initialisation du jeu
        function initGame() {
            loadGame();
            updateUI();
            // Boucle de mise √† jour du jeu
            setInterval(updateGame, 1000);
            setInterval(checkWeatherEvent, 5000); // V√©rification m√©t√©o plus fr√©quente
        }

        // Affichage des √©crans
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            // Mise √† jour des boutons de navigation
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const raceActive = gameState.currentRace !== null;
            const continueBtn = document.getElementById('continue-race-btn');
            const shopRaceBtn = document.getElementById('shop-race-btn');
            const rankingsRaceBtn = document.getElementById('rankings-race-btn');
            
            if (continueBtn) continueBtn.style.display = raceActive ? 'inline-block' : 'none';
            if (shopRaceBtn) shopRaceBtn.style.display = raceActive ? 'inline-block' : 'none';
            if (rankingsRaceBtn) rankingsRaceBtn.style.display = raceActive ? 'inline-block' : 'none';
        }

        // Gestion des courses
        function startRace() {
            const difficulty = document.getElementById('difficulty-select').value;
            const duration = parseInt(document.getElementById('duration-select').value);
            
            gameState.currentRace = {
                difficulty: difficulty,
                duration: duration * 60000, // Conversion en millisecondes
                startTime: Date.now(),
                position: Math.floor(Math.random() * 3) + 1,
                totalDistance: 1000,
                currentDistance: 0,
                sailSetting: 50,
                heading: 180,
                speed: 15,
                weatherEffect: null,
                currentSailType: 'full',
                crewFatigue: 0,
                lastWeatherChange: Date.now(),
                autopilotActive: false
            };
            
            showScreen('race-screen');
            updateRaceUI();
        }

        function updateRaceUI() {
            if (!gameState.currentRace) return;
            
            const race = gameState.currentRace;
            const elapsed = Date.now() - race.startTime;
            const progress = Math.min((elapsed / race.duration) * 100, 100);
            
            document.getElementById('race-position').textContent = `${race.position}/10`;
            document.getElementById('race-speed').textContent = `${race.speed} n≈ìuds`;
            document.getElementById('race-time').textContent = formatTime(elapsed);
            document.getElementById('race-progress').textContent = `${progress.toFixed(1)}%`;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            
            // Mise √† jour de la position du voilier sur la carte
            updateBoatPosition(progress);
            
            // Mise √† jour de l'indicateur de vent
            updateWindIndicator();
            
            // V√©rifier si la course est termin√©e
            if (progress >= 100) {
                finishRace();
            }
        }

        function updateBoatPosition(progress) {
            const playerBoat = document.getElementById('player-boat');
            if (playerBoat) {
                const position = 8 + (progress * 0.84); // De 8% √† 92% de la largeur
                playerBoat.style.left = `${position}%`;
                
                // Animation plus prononc√©e quand le bateau va vite
                if (gameState.currentRace && gameState.currentRace.speed > 18) {
                    playerBoat.style.animation = 'sailing 1.5s ease-in-out infinite';
                } else {
                    playerBoat.style.animation = 'sailing 3s ease-in-out infinite';
                }
            }
            
            // Mise √† jour des positions des concurrents (simulation)
            updateCompetitorPositions(progress);
        }

        function updateCompetitorPositions(progress) {
            const competitors = ['competitor-1', 'competitor-2', 'competitor-3'];
            
            competitors.forEach((id, index) => {
                const competitor = document.getElementById(id);
                if (competitor && gameState.currentRace) {
                    // Calcul de la performance des IA bas√©e sur la difficult√©
                    let aiPerformance = 1.0;
                    let aiVariance = 20;
                    
                    switch(gameState.currentRace.difficulty) {
                        case 'debutant':
                            aiPerformance = 0.7; // IA 30% plus lentes
                            aiVariance = 30; // Plus d'erreurs
                            break;
                        case 'intermediaire':
                            aiPerformance = 0.95; // IA l√©g√®rement plus lentes
                            aiVariance = 15;
                            break;
                        case 'expert':
                            aiPerformance = 1.15; // IA 15% plus rapides
                            aiVariance = 8; // Tr√®s consistantes
                            
                            // En expert, les IA "optimisent" automatiquement mieux
                            if (index === 0) aiPerformance = 1.25; // Leader IA tr√®s fort
                            break;
                    }
                    
                    // Performance bas√©e sur l'optimisation du joueur
                    const playerOptimization = calculatePlayerOptimization();
                    let competitorProgress = progress * aiPerformance;
                    
                    // En mode expert, si le joueur n'optimise pas bien, les IA en profitent
                    if (gameState.currentRace.difficulty === 'expert' && playerOptimization < 70) {
                        competitorProgress += (70 - playerOptimization) * 0.5;
                    }
                    
                    // Ajouter une variance mais moins en expert
                    const variance = (Math.random() - 0.5) * aiVariance;
                    competitorProgress += variance;
                    
                    const clampedProgress = Math.max(0, Math.min(100, competitorProgress));
                    const position = 8 + (clampedProgress * 0.84);
                    competitor.style.left = `${position}%`;
                    
                    // Ajustement vertical pour √©viter la superposition
                    const verticalOffset = 45 + (index * 5) + Math.sin(Date.now() / 1000 + index) * 3;
                    competitor.style.top = `${verticalOffset}%`;
                }
            });
        }

        function calculatePlayerOptimization() {
            if (!gameState.currentRace) return 50;
            
            const sailValue = gameState.currentRace.sailSetting || 50;
            const headingValue = gameState.currentRace.heading || 180;
            
            // Logique d'optimisation
            const optimalSail = 70;
            const optimalHeading = 45;
            
            const sailDiff = Math.abs(sailValue - optimalSail);
            const headingDiff = Math.abs(headingValue - optimalHeading);
            
            return 100 - (sailDiff + headingDiff * 0.5);
        }

        function updateWindIndicator() {
            const windIndicator = document.getElementById('wind-indicator');
            if (windIndicator && gameState.currentRace) {
                const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
                const direction = directions[Math.floor(Date.now() / 10000) % directions.length];
                const windSpeed = 10 + Math.floor(Math.random() * 15);
                
                let weatherIcon = 'üå¨Ô∏è';
                if (gameState.currentRace.weatherEffect) {
                    switch(gameState.currentRace.weatherEffect.name) {
                        case 'Temp√™te': weatherIcon = '‚õàÔ∏è'; break;
                        case 'Vent Favorable': weatherIcon = 'üí®'; break;
                        case 'Calme Plat': weatherIcon = 'üò¥'; break;
                        case 'Grain': weatherIcon = 'üå©Ô∏è'; break;
                    }
                }
                
                windIndicator.textContent = `${weatherIcon} Vent: ${windSpeed} nds ${direction}`;
            }
        }

        function finishRace() {
            const race = gameState.currentRace;
            const elapsed = Date.now() - race.startTime;
            const position = race.position;
            
            // Calcul des r√©compenses
            let reward = 0;
            if (position === 1) {
                reward = 500;
                gameState.player.victories++;
            } else if (position === 2) {
                reward = 300;
            } else if (position === 3) {
                reward = 150;
            } else {
                reward = 50;
            }
            
            // Bonus de difficult√©
            if (race.difficulty === 'expert') {
                reward = Math.floor(reward * 1.5);
            }
            
            gameState.player.money += reward;
            gameState.player.racesCompleted++;
            gameState.player.totalEarned += reward;
            
            // Mise √† jour du meilleur temps
            if (!gameState.player.bestTime || elapsed < gameState.player.bestTime) {
                gameState.player.bestTime = elapsed;
            }
            
            // Ajouter √† l'historique
            gameState.raceHistory.push({
                date: new Date().toLocaleDateString(),
                time: formatTime(elapsed),
                position: position,
                reward: reward,
                difficulty: race.difficulty
            });
            
            gameState.currentRace = null;
            alert(`Course termin√©e!\nPosition: ${position}\nR√©compense: ${reward}‚Ç¨`);
            showScreen('main-screen');
            updateUI();
        }

        function abandonRace() {
            if (confirm('√ätes-vous s√ªr de vouloir abandonner la course ?')) {
                gameState.currentRace = null;
                showScreen('main-screen');
                updateUI();
            }
        }

        // Optimisation des voiles et du cap
        function updateSailOptimization() {
            const value = document.getElementById('sail-slider').value;
            document.getElementById('sail-value').textContent = value;
            updateOptimization();
        }

        function updateHeadingOptimization() {
            const value = document.getElementById('heading-slider').value;
            document.getElementById('heading-value').textContent = value;
            updateOptimization();
        }

        function updateOptimization() {
            const sailValue = document.getElementById('sail-slider').value;
            const headingValue = document.getElementById('heading-slider').value;

            // Correction : d√©finition de sailMultiplier
            const sailType = gameState.currentRace.currentSailType;
            const sailData = sailTypes[sailType] || sailTypes['full'];
            const sailMultiplier = sailData.speed;
            
            const optimization = calculatePlayerOptimization();
            
            const statusElement = document.getElementById('optimization-status');
            
            if (optimization > 80) {
                statusElement.textContent = 'üü¢ Optimisation Excellente';
                statusElement.className = 'optimization-indicator optimal';
                gameState.currentRace.speed = (20 + gameState.upgrades.hull * 2) * sailMultiplier;
            } else if (optimization > 50) {
                statusElement.textContent = 'üü° Optimisation Moyenne';
                statusElement.className = 'optimization-indicator good';
                gameState.currentRace.speed = (15 + gameState.upgrades.hull * 2) * sailMultiplier;
            } else {
                statusElement.textContent = 'üî¥ Optimisation Faible';
                statusElement.className = 'optimization-indicator poor';
                gameState.currentRace.speed = (10 + gameState.upgrades.hull * 2) * sailMultiplier;
            }
            
            gameState.currentRace.sailSetting = sailValue;
            gameState.currentRace.heading = headingValue;
            
            // Mise √† jour de la fatigue
            updateCrewFatigue();
        }

        function updateCrewFatigue() {
            if (!gameState.currentRace) return;
            
            // La fatigue augmente avec le temps et les man≈ìuvres
            const elapsed = Date.now() - gameState.currentRace.startTime;
            const baseFatigue = (elapsed / gameState.currentRace.duration) * 30;
            
            // R√©duction de fatigue avec pilote automatique
            if (gameState.currentRace.autopilotActive) {
                gameState.currentRace.crewFatigue = Math.max(0, baseFatigue * 0.3);
            } else {
                gameState.currentRace.crewFatigue = Math.min(100, baseFatigue);
            }
            
            document.getElementById('crew-fatigue').textContent = `${Math.floor(gameState.currentRace.crewFatigue)}%`;
        }

        // Gestion de la boutique
        function initShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            for (const [key, data] of Object.entries(upgradeData)) {
                const currentLevel = gameState.upgrades[key] || 0;
                const basePrice = gameState.shopPrices[key] || 1000;
                const price = Math.floor(basePrice * Math.pow(1.5, currentLevel));
                const canAfford = gameState.player.money >= price;
                const maxReached = currentLevel >= data.maxLevel;
                
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.innerHTML = `
                    <div>
                        <h4>${data.name}</h4>
                        <p>Niveau: ${currentLevel}/${data.maxLevel}</p>
                        <p>Effet: ${data.effect}</p>
                        <p>Prix: ${price}‚Ç¨</p>
                    </div>
                    <button class="btn ${canAfford && !maxReached ? 'success' : ''}" 
                            onclick="buyUpgrade('${key}')" 
                            ${!canAfford || maxReached ? 'disabled' : ''}>
                        ${maxReached ? 'MAX' : 'Acheter'}
                    </button>
                `;
                shopItems.appendChild(item);
            }
        }

        function buyUpgrade(type) {
            const currentLevel = gameState.upgrades[type] || 0;
            const basePrice = gameState.shopPrices[type] || 1000;
            const price = Math.floor(basePrice * Math.pow(1.5, currentLevel));
            const maxLevel = upgradeData[type] ? upgradeData[type].maxLevel : 10;
            
            if (gameState.player.money >= price && currentLevel < maxLevel) {
                gameState.player.money -= price;
                gameState.upgrades[type] = currentLevel + 1;
                gameState.player.upgradesBought++;
                
                showNotification(`‚úÖ ${upgradeData[type].name} am√©lior√© au niveau ${gameState.upgrades[type]} !`, 'success');
                
                updateUI();
                initShop();
            } else if (gameState.player.money < price) {
                showNotification(`‚ùå Argent insuffisant ! Il vous faut ${price}‚Ç¨`, 'error');
            } else {
                showNotification(`‚ùå Niveau maximum atteint !`, 'warning');
            }
        }

        // Gestion du manager
        function initManager() {
            const managerItems = document.getElementById('manager-items');
            managerItems.innerHTML = '';
            
            for (const [key, data] of Object.entries(upgradeData)) {
                const item = document.createElement('div');
                item.className = 'shop-item';
                item.innerHTML = `
                    <div>
                        <h4>${data.name}</h4>
                        <p>Prix de base: ${gameState.shopPrices[key]}‚Ç¨</p>
                    </div>
                    <input type="number" value="${gameState.shopPrices[key]}" 
                           onchange="updatePrice('${key}', this.value)" 
                           style="width: 100px; margin-right: 10px;">
                `;
                managerItems.appendChild(item);
            }
            // Ajout du r√©glage m√©t√©o
            const weatherDiv = document.createElement('div');
            weatherDiv.className = 'shop-item';
            weatherDiv.innerHTML = `
                <div>
                    <h4>Intervalle Intemp√©ries</h4>
                    <p>Temps entre deux intemp√©ries (minutes)</p>
                </div>
                <input type="number" min="1" max="60" value="${gameState.weatherIntervalMinutes}" 
                       onchange="updateWeatherInterval(this.value)" style="width: 100px; margin-right: 10px;">
            `;
            managerItems.appendChild(weatherDiv);
        }

        function updatePrice(type, newPrice) {
            gameState.shopPrices[type] = parseInt(newPrice);
            updateUI();
        }

        function updateWeatherInterval(newInterval) {
            gameState.weatherIntervalMinutes = parseInt(newInterval);
            updateUI();
        }

        function resetPrices() {
            gameState.shopPrices = {
                hull: 500,
                sail: 300,
                rudder: 200,
                engine: 800,
                autopilot: 1000
            };
            gameState.weatherIntervalMinutes = 5;
            initManager();
        }

        // Gestion des changements m√©t√©o adaptatifs
        function checkWeatherEvent() {
            if (!gameState.currentRace) return;
            
            const elapsed = Date.now() - gameState.currentRace.lastWeatherChange;
            let weatherInterval;
            
            // Utilisation du r√©glage manager si d√©fini
            if (typeof gameState.weatherIntervalMinutes === 'number' && gameState.weatherIntervalMinutes > 0) {
                weatherInterval = gameState.weatherIntervalMinutes * 60000;
            } else {
                // Fr√©quence adaptative selon la dur√©e de course (fallback)
                if (gameState.currentRace.duration <= 1800000) { // 30 min ou moins
                    weatherInterval = 60000; // 1 minute
                } else if (gameState.currentRace.duration <= 10800000) { // 3h ou moins
                    weatherInterval = 300000; // 5 minutes
                } else {
                    weatherInterval = 900000; // 15 minutes
                }
            }
            
            if (elapsed >= weatherInterval) {
                const event = weatherEvents[Math.floor(Math.random() * weatherEvents.length)];
                gameState.currentRace.weatherEffect = {
                    ...event,
                    endTime: Date.now() + event.duration
                };
                gameState.currentRace.lastWeatherChange = Date.now();
                
                const weatherAlert = document.getElementById('weather-alert');
                weatherAlert.textContent = `‚õàÔ∏è ${event.name}: ${event.effect} - Voiles recommand√©es: ${sailTypes[event.sailChange].name}`;
                weatherAlert.style.display = 'block';
                
                // Pilote automatique r√©agit automatiquement
                if (gameState.currentRace.autopilotActive) {
                    gameState.currentRace.currentSailType = event.sailChange;
                    document.getElementById('sail-type-select').value = event.sailChange;
                    showNotification(`ü§ñ Pilote auto: Voiles chang√©es pour ${sailTypes[event.sailChange].name}`, 'info');
                }
                
                setTimeout(() => {
                    weatherAlert.style.display = 'none';
                    if (gameState.currentRace) {
                        gameState.currentRace.weatherEffect = null;
                    }
                }, event.duration);
            }
        }

        // Nouvelle fonction pour changer le type de voiles
        function changeSailType() {
            if (!gameState.currentRace) return;
            
            const newSailType = document.getElementById('sail-type-select').value;
            gameState.currentRace.currentSailType = newSailType;
            
            // Augmentation de la fatigue lors du changement de voiles
            if (!gameState.currentRace.autopilotActive) {
                gameState.currentRace.crewFatigue = Math.min(100, gameState.currentRace.crewFatigue + 5);
            }
            
            updateOptimization();
            showNotification(`‚õµ Voiles chang√©es: ${sailTypes[newSailType].name}`, 'info');
        }

        // Fonction pour activer/d√©sactiver le pilote automatique
        function toggleAutopilot() {
            if (!gameState.currentRace) return;
            
            if (gameState.upgrades.autopilot === 0) {
                showNotification('‚ùå Pilote automatique non disponible. Achetez-le en boutique !', 'error');
                return;
            }
            
            gameState.currentRace.autopilotActive = !gameState.currentRace.autopilotActive;
            const btn = document.getElementById('autopilot-btn');
            
            if (gameState.currentRace.autopilotActive) {
                btn.textContent = '‚è∏Ô∏è D√©sactiver';
                btn.className = 'btn warning';
                showNotification('ü§ñ Pilote automatique activ√©', 'success');
            } else {
                btn.textContent = '‚ñ∂Ô∏è Activer';
                btn.className = 'btn';
                showNotification('üë®‚Äç‚úàÔ∏è Pilote manuel activ√©', 'info');
            }
        }

        // Gestion des classements
        function updateRankings() {
            // Historique des courses
            const historyElement = document.getElementById('race-history');
            historyElement.innerHTML = '';
            
            gameState.raceHistory.slice(-10).reverse().forEach((race, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div>
                        <strong>${race.date}</strong><br>
                        Difficult√©: ${race.difficulty}<br>
                        Temps: ${race.time}
                    </div>
                    <div style="text-align: right;">
                        <strong>Position: ${race.position}</strong><br>
                        R√©compense: ${race.reward}‚Ç¨
                    </div>
                `;
                historyElement.appendChild(item);
            });
            
            // Classement actuel (simul√©) - RESET √† 0
            const leaderboard = document.getElementById('current-leaderboard');
            leaderboard.innerHTML = '';
            
            const currentRanking = [
                { name: 'Vous', position: 1, points: 0 },
                { name: 'Captain Morgan', position: 2, points: 0 },
                { name: 'Sea Wolf', position: 3, points: 0 },
                { name: 'Storm Rider', position: 4, points: 0 },
                { name: 'Wave Master', position: 5, points: 0 }
            ].sort((a, b) => b.points - a.points);
            
            currentRanking.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div>
                        <strong>${index + 1}. ${player.name}</strong>
                    </div>
                    <div>
                        <strong>${player.points} pts</strong>
                    </div>
                `;
                leaderboard.appendChild(item);
            });
        }

        // Simulation du temps d'absence avec pilote automatique
        function simulateAbsence() {
            const lastSave = JSON.parse(localStorage.getItem('sailingGameLastSave') || '{}');
            if (lastSave.timestamp && gameState.currentRace) {
                const timeDiff = Date.now() - lastSave.timestamp;
                const raceElapsed = Date.now() - gameState.currentRace.startTime;
                
                // Ajuster le temps de d√©but de la course
                gameState.currentRace.startTime = Date.now() - (raceElapsed + timeDiff);
                
                // Performance du pilote automatique pendant l'absence
                if (timeDiff > 0) {
                    const autopilotLevel = gameState.upgrades.autopilot;
                    let autopilotEfficiency = 0.3 + (autopilotLevel * 0.07); // 30% √† 100% selon niveau
                    
                    if (autopilotLevel === 0) {
                        autopilotEfficiency = 0.1; // Tr√®s mauvais sans pilote auto
                        showNotification('‚ö†Ô∏è Absence sans pilote automatique : performances d√©grad√©es !', 'warning');
                    } else {
                        showNotification(`ü§ñ Pilote automatique niveau ${autopilotLevel} a g√©r√© votre absence`, 'info');
                    }
                    
                    const progressDuringAbsence = Math.min(timeDiff / gameState.currentRace.duration, 0.8) * autopilotEfficiency;
                    gameState.currentRace.currentDistance += progressDuringAbsence * gameState.currentRace.totalDistance;
                    
                    // Le pilote automatique active automatiquement le mode auto
                    if (autopilotLevel > 0) {
                        gameState.currentRace.autopilotActive = true;
                    }
                }
            }
        }

        // Sauvegarde et chargement
        function saveGame() {
            const saveData = {
                ...gameState,
                timestamp: Date.now()
            };
            localStorage.setItem('sailingGameSave', JSON.stringify(saveData));
            localStorage.setItem('sailingGameLastSave', JSON.stringify({ timestamp: Date.now() }));
            alert('Jeu sauvegard√© avec succ√®s !');
        }

        function loadGame() {
            const savedData = localStorage.getItem('sailingGameSave');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                gameState = { ...gameState, ...parsed };
                simulateAbsence();
                updateUI();
                
                // Restaurer les r√©glages de course si une course est en cours
                if (gameState.currentRace) {
                    document.getElementById('sail-slider').value = gameState.currentRace.sailSetting || 50;
                    document.getElementById('heading-slider').value = gameState.currentRace.heading || 180;
                    document.getElementById('sail-value').textContent = gameState.currentRace.sailSetting || 50;
                    document.getElementById('heading-value').textContent = gameState.currentRace.heading || 180;
                    document.getElementById('sail-type-select').value = gameState.currentRace.currentSailType || 'full';
                    
                    // Restaurer l'√©tat du pilote automatique
                    const autopilotBtn = document.getElementById('autopilot-btn');
                    if (gameState.currentRace.autopilotActive && autopilotBtn) {
                        autopilotBtn.textContent = '‚è∏Ô∏è D√©sactiver';
                        autopilotBtn.className = 'btn warning';
                    }
                    
                    updateOptimization();
                }
            }
        }

        function exportSave() {
            const saveData = JSON.stringify(gameState, null, 2);
            const blob = new Blob([saveData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sailing_game_save.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importSave() {
            const file = document.getElementById('import-file').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        gameState = { ...gameState, ...importedData };
                        updateUI();
                        alert('Sauvegarde import√©e avec succ√®s !');
                    } catch (error) {
                        alert('Erreur lors de l\'importation de la sauvegarde');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Mise √† jour de l'interface
        function updateUI() {
            // Statistiques principales
            document.getElementById('player-money').textContent = `${gameState.player.money} ‚Ç¨`;
            document.getElementById('races-completed').textContent = gameState.player.racesCompleted;
            document.getElementById('victories').textContent = gameState.player.victories;
            document.getElementById('best-time').textContent = gameState.player.bestTime ? formatTime(gameState.player.bestTime) : '--:--';
            
            // Boutique
            const shopMoney = document.getElementById('shop-money');
            if (shopMoney) shopMoney.textContent = `${gameState.player.money} ‚Ç¨`;
            
            // Manager
            const totalEarned = document.getElementById('total-earned');
            const totalPlaytime = document.getElementById('total-playtime');
            const upgradesBought = document.getElementById('upgrades-bought');
            
            if (totalEarned) totalEarned.textContent = `${gameState.player.totalEarned} ‚Ç¨`;
            if (totalPlaytime) {
                const playtime = Math.floor((Date.now() - gameState.startTime) / 60000);
                totalPlaytime.textContent = `${Math.floor(playtime / 60)}h ${playtime % 60}m`;
            }
            if (upgradesBought) upgradesBought.textContent = gameState.player.upgradesBought;
            
            // Mise √† jour des boutons de navigation
            updateNavigationButtons();
        }

        // Boucle de mise √† jour du jeu
        function updateGame() {
            if (gameState.currentRace) {
                updateRaceUI();
                // V√©rification suppl√©mentaire apr√®s updateRaceUI (car finishRace peut √™tre appel√©e)
                if (!gameState.currentRace) return;
                
                // Simulation de la position en course avec IA plus intelligentes
                const elapsed = Date.now() - gameState.currentRace.startTime;
                const raceProgress = elapsed / gameState.currentRace.duration;
                
                // Calcul de l'optimisation du joueur
                const playerOptimization = calculatePlayerOptimization();
                
                // Ajustement de position bas√© sur la performance et la difficult√©
                let positionChange = 0;
                
                if (gameState.currentRace.difficulty === 'expert') {
                    // En expert, les IA sont tr√®s agressives
                    if (playerOptimization > 85 && Math.random() < 0.08) {
                        positionChange = -1; // Chance de d√©passer
                    } else if (playerOptimization < 60 && Math.random() < 0.15) {
                        positionChange = 1; // Risque √©lev√© de se faire d√©passer
                    } else if (playerOptimization < 40 && Math.random() < 0.25) {
                        positionChange = 2; // Tr√®s mauvaise optimisation = chute rapide
                    }
                } else if (gameState.currentRace.difficulty === 'intermediaire') {
                    // √âquilibr√©
                    if (playerOptimization > 80 && Math.random() < 0.05) {
                        positionChange = -1;
                    } else if (playerOptimization < 50 && Math.random() < 0.08) {
                        positionChange = 1;
                    }
                } else {
                    // D√©butant - plus cl√©ment
                    if (playerOptimization > 75 && Math.random() < 0.12) {
                        positionChange = -1;
                    } else if (playerOptimization < 30 && Math.random() < 0.05) {
                        positionChange = 1;
                    }
                }
                
                // Appliquer le changement de position
                gameState.currentRace.position = Math.max(1, Math.min(10, gameState.currentRace.position + positionChange));
                
                // Notification si changement de position significatif
                if (positionChange !== 0) {
                    const newPos = gameState.currentRace.position;
                    if (positionChange < 0) {
                        showNotification(`üöÄ Vous √™tes maintenant ${newPos}e !`, 'success');
                    } else {
                        showNotification(`‚ö†Ô∏è Vous glissez √† la ${newPos}e place !`, 'warning');
                    }
                }
            }
            
            // Sauvegarde automatique toutes les 5 minutes
            if (Date.now() % 300000 < 1000) {
                saveGame();
            }
        }

        // Utilitaires
        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (hours > 0) {
                return `${hours}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${(seconds % 60).toString().padStart(2, '0')}`;
            }
        }

        // √âcouteurs d'√©v√©nements
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            
            // Initialisation des √©crans
            document.addEventListener('click', function(e) {
                if (e.target.closest('#shop')) {
                    initShop();
                } else if (e.target.closest('#manager')) {
                    initManager();
                } else if (e.target.closest('#rankings')) {
                    updateRankings();
                }
            });
            
            // Sauvegarde avant fermeture
            window.addEventListener('beforeunload', function() {
                saveGame();
            });
            
            // Gestion de la visibilit√© de la page
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    saveGame();
                } else {
                    loadGame();
                }
            });
        });

        // Fonctions suppl√©mentaires pour am√©liorer l'exp√©rience
        function resetGame() {
            if (confirm('√ätes-vous s√ªr de vouloir r√©initialiser compl√®tement le jeu ?')) {
                localStorage.removeItem('sailingGameSave');
                localStorage.removeItem('sailingGameLastSave');
                location.reload();
            }
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // Gestion des touches pour les raccourcis
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                showScreen('main-screen');
            } else if (e.key === 's' && e.ctrlKey) {
                e.preventDefault();
                saveGame();
            } else if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                loadGame();
            }
        });

        // Animation des vagues pour l'arri√®re-plan
        function createWaveAnimation() {
            const style = document.createElement('style');
            style.textContent = `
                body::before {
                    content: '';
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: 
                        radial-gradient(circle at 20% 80%, rgba(120, 215, 255, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
                    pointer-events: none;
                    z-index: -1;
                    animation: waveMove 20s ease-in-out infinite;
                }
                
                @keyframes waveMove {
                    0%, 100% { transform: translateX(0) translateY(0); }
                    25% { transform: translateX(-10px) translateY(-5px); }
                    50% { transform: translateX(5px) translateY(10px); }
                    75% { transform: translateX(-5px) translateY(-10px); }
                }
            `;
            document.head.appendChild(style);
        }

        // Initialisation de l'animation des vagues
        createWaveAnimation();

        // Ajout d'effets sonores (simulation)
        function playSound(soundType) {
            // Ici, vous pourriez ajouter des vrais sons
            console.log(`üîä Son: ${soundType}`);
        }

        // Am√©liorations visuelles pour les transitions
        function addTransitionEffects() {
            const style = document.createElement('style');
            style.textContent = `
                .btn {
                    position: relative;
                    overflow: hidden;
                }
                
                .btn::before {
                    content: '';
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
                    transition: left 0.5s;
                }
                
                .btn:hover::before {
                    left: 100%;
                }
                
                .card {
                    transition: transform 0.3s ease, box-shadow 0.3s ease;
                }
                
                .card:hover {
                    transform: translateY(-5px);
                    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
                }
            `;
            document.head.appendChild(style);
        }

        addTransitionEffects();

        // Syst√®me de notifications
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            
            switch(type) {
                case 'success':
                    notification.style.background = '#27ae60';
                    break;
                case 'warning':
                    notification.style.background = '#f39c12';
                    break;
                case 'error':
                    notification.style.background = '#e74c3c';
                    break;
                default:
                    notification.style.background = '#3498db';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Ajout des animations CSS pour les notifications
        const notificationStyle = document.createElement('style');
        notificationStyle.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(notificationStyle);
    // Fonction pour mettre √† jour l'intervalle m√©t√©o depuis le menu manager
function updateWeatherInterval(newValue) {
    const val = parseInt(newValue);
    if (!isNaN(val) && val > 0 && val <= 60) {
        gameState.weatherIntervalMinutes = val;
    }
}

</script>
</body>
</html>